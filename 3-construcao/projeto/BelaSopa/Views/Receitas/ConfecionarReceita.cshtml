@model (Receita Receita, IList<Tecnica> Tecnicas, IList<Utensilio> Utensilios, bool Favorita, int Processo)
@{
    Layout = "_LayoutAutenticado";
    ViewData["Title"] = "Confecionar";
    ViewData["HideHeading"] = true;
}

<div class="container">
    <div class="row">
        <div class="col-sm-8">
            <img src="@GestorImagens.GetPathImagemReceita(Url, Model.Receita.ReceitaId)"
                 alt="@Model.Receita.Nome"
                 style="max-width: 100%; object-fit: cover;" />
            <i class="fas fa-star" style="color:gold;position:absolute; left:1em; top:0.5em; font-size:2em"></i>
        </div>
        <div class="col-sm-4" style="text-align:center;border-left: 3px solid #4CAF50;">
            <h4>Model.Receita.Nome</h4>
            <span><i class="fas fa-signal" style="color: green; margin-right: 0.5em;"></i>Fácil</span>
            <span style="margin-left:1em;"><i class="fas fa-clock" style="margin-right: 0.5em;"></i>10 min</span>
            <span style="margin-left:1em;">2 doses</span>
            <div style="text-align:left;margin-top:1em;">
                Etiquetas:
                <ul class="CustomBullet" style="text-align:left;list-style: none">
                    @foreach (var etiqueta in Model.Receita.ReceitaEtiqueta) {
                        <li>
                            @etiqueta.Etiqueta.Nome
                        </li>
                    }
                </ul>
            </div>
        </div>
    </div>
</div>

<p class="font-italic" style="margin-top:3em">@Model.Receita.Descricao</p>

<hr />

<h3>Processo</h3>

<br />
<div class="row">
    <a asp-action="Confecionar"
       asp-route-id="@Model.Receita.ReceitaId"
       asp-route-indiceProcesso="@(Model.Processo - 1)"
       class="btn btn-primary"
       style="background-color:#4CAF50; border-color:#4CAF50;">
        Processo anterior
    </a>
    <a asp-action="Confecionar"
       asp-route-id="@Model.Receita.ReceitaId"
       asp-route-indiceProcesso="@(Model.Processo + 1)"
       class="btn btn-primary"
       style="background-color:#4CAF50; border-color:#4CAF50;">
        Processo seguinte
    </a>
    <a asp-action="Cancelar"
       asp-route-id="@Model.Receita.ReceitaId"
       class="btn btn-primary"
       style="background-color:#4CAF50; border-color:#4CAF50;">
        Cancelar
    </a>
</div>

<div class="container">
    <div class="row">
        <div class="col">
            <h4 style="margin-top:2em;">Ingredientes</h4>
            <table class="table">
                <thead class="thead-light">
                    <tr>
                        <th scope="col"></th>
                        <th scope="col">Quantidade</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var ingrediente in Model.Receita.UtilizacoesIngredientes) {
                        <tr>
                            <td>
                                <text>@ingrediente.Nome</text>
                            </td>
                            <td>@ingrediente.Quantidade</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="col">
            <h4 style="margin-top:2em;">Técnicas</h4>
            <ul class="CustomBullet" style="text-align:left;list-style: none">
                @foreach (var tecnica in Model.Tecnicas) {
                    <li>
                        @tecnica.Nome
                    </li>
                }
            </ul>

        </div>
        <div class="col">
            <h4 style="margin-top:2em;">Utensílios</h4>
            <ul class="CustomBullet" style="text-align:left;list-style: none">
                @foreach (var utensilio in Model.Utensilios) {
                    <li>
                        @utensilio.Nome
                    </li>
                }
            </ul>
        </div>
    </div>
</div>

<hr />

<h4 style="margin-top:2em;">Passos</h4>


@{
    var cronometroID = 0;
}
@{ Processo processo = Model.Receita.Processos.OrderBy(p => p.Indice).ToList<Processo>()[@Model.Processo]; }
<ul class="CustomBullet" style="text-align:left;list-style: none;margin-bottom:2em;">
    @foreach (var tar in processo.Tarefas) {
        <li>
            @foreach (var texto in tar.Texto.OrderBy(t => t.Indice)) {
                if (texto.IngredienteId != null) {
                    <a asp-controller="Ingredientes" asp-action="Detalhes" asp-route-id="@texto.IngredienteId">@texto.Texto</a>
                } else if (texto.TecnicaId != null) {
                    <a asp-controller="Tecnicas" asp-action="Detalhes" asp-route-id="@texto.TecnicaId">@texto.Texto</a>
                } else if (texto.UtensilioId != null) {
                    <a asp-controller="Utensilios" asp-action="Detalhes" asp-route-id="@texto.UtensilioId">@texto.Texto</a>
                } else {
                    <text>@texto.Texto</text>
                }
            }
            @{
                var temporizador = tar.GetDuracaoTemporizador();

                if (temporizador != null) {

                    var duracaoTemporizador = Int32.Parse(tar.GetDuracaoTemporizador()) * 60000;
                    var str = "Temporixador do Passo " + cronometroID + " concluido";
                    <a onclick="startTimeOut(@duracaoTemporizador, '@str', @cronometroID)">
                        @{
                            var strCronometroID = "stopwatch" + cronometroID;
                            var strTimeLeft = "TimeLeft" + cronometroID;
                            cronometroID++;
                        }
                        <i id=@strCronometroID class="fas fa-stopwatch"></i>
                        <span id=@strTimeLeft style="display:none;"></span>
                    </a>
                }
            }
        </li>
    }
</ul>

<script>
    var myVar = [];
    var x = [];

    function startTimeOut(time, str, id) {
        var countDownDate;
        var s = document.getElementById("stopwatch" + id);

        if (s.classList.contains('fa-stopwatch')) {
            s.classList.remove('fa-stopwatch');
            s.classList.add('fa-stop');
            s.style.color = "red";

            var now = new Date().getTime();
            var aux = new Date(time).getTime();

            countDownDate = now + aux;

            x[id] = setInterval(function () {

                var now = new Date().getTime();

                var distance = countDownDate - now;

                var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                var seconds = Math.floor((distance % (1000 * 60)) / 1000);

                document.getElementById("TimeLeft" + id).style.display = "block";
                document.getElementById("TimeLeft" + id).innerHTML = minutes + "m " + seconds + "s";

                // If the count down is finished, write some text
                if (distance < 0) {
                    clearInterval(x[id]);
                    document.getElementById("TimeLeft" + id).style.display = "none";
                    document.getElementById("TimeLeft" + id).innerHTML = "";
                }
            }, 1000);


            myVar[id] = setTimeout(function () {
                clearInterval(x[id]);
                document.getElementById("TimeLeft" + id).style.display = "none";
                s.classList.remove('fa-stop');
                s.classList.add('fa-stopwatch');
                s.style.color = "black";
                alert(str);
            }, time)
        }
        else {
            clearInterval(x[id]);
            clearTimeout(myVar[id]);
            document.getElementById("TimeLeft" + id).style.display = "none";
            s.classList.remove('fa-stop');
            s.classList.add('fa-stopwatch');
            s.style.color = "black";
        }
    }
</script>

<hr style="border-color:#4CAF50; border-width:4px;" />

<!--===================================Informação completa===================================-->
<!--
<h2>Informação Completa</h2>
<h4 style="margin-top:2em;">Ingredientes</h4>
<table class="table">
    <thead class="thead-light">
        <tr>
            <th scope="col"></th>
            <th scope="col">Quantidade</th>
        </tr>
    </thead>
    <tbody>()

    foreach (var utilizacaoIngrediente in Model.Receita.UtilizacoesIngredientes.OrderBy(ui => ui.Nome))
        {
            <tr>
                <td>
                    if (utilizacaoIngrediente.Ingrediente != null)
                    {
                        <a asp-controller="Ingredientes"
                            asp-action="Detalhes"
                            asp-route-id="utilizacaoIngrediente.Ingrediente.IngredienteId">
                            utilizacaoIngrediente.Nome
                        </a>
                    }
                    else
                    {
                        <text>utilizacaoIngrediente.Nome</text>
                    }
                </td>
                <td>utilizacaoIngrediente.Quantidade</td>
            </tr>
        }
    </tbody>
</table>
<hr />
<h4 style="margin-top:2em;">Técnicas</h4>
<ul>
    foreach (var tecnica in Model.Tecnicas)
    {
        <li>
            <a asp-controller="Tecnicas" asp-action="Detalhes" asp-route-id="tecnica.TecnicaId">tecnica.Nome</a>
        </li>
    }
</ul>
<hr />
<h4 style="margin-top:2em;">Utensílios</h4>
<ul>
    foreach (var utensilio in Model.Utensilios)
    {
        <li>
            <a asp-controller="Utensilios" asp-action="Detalhes" asp-route-id="utensilio.UtensilioId">utensilio.Nome</a>
        </li>
    }
</ul>
<hr />
<h4 style="margin-top:2em;">Valores nutricionais</h4>
<table class="table">
    <thead class="thead-light">
        <tr>
            <th scope="col"></th>
            <th scope="col">Dose</th>
            <th scope="col">% do VDR adulto</th>
        </tr>
    </thead>
    <tbody>
        { var i = 0;}
        foreach (var valor in Model.Receita.ValoresNutricionais.OrderBy(vn => vn.Nome))
        {
            if (i == 0)
            {
                <tr>
                    <td>valor.Nome</td>
                    <td>valor.Dose</td>
                    <td>
                        if (valor.PercentagemVdrAdulto != null)
                        {valor.PercentagemVdrAdulto<text>%</text>}
                    </td>
                </tr>
                i++;
            }
            else
            {
                <tr id="ValoresNut">
                    <td>valor.Nome</td>
                    <td>valor.Dose</td>
                    <td>
                        if (valor.PercentagemVdrAdulto != null)
                        {valor.PercentagemVdrAdulto<text>%</text>}
                    </td>
                </tr>
                i--;
            }
        }
    </tbody>
</table>
<hr />
<h4 style="margin-top:2em;">Passos</h4>
<ul class="CustomBullet" style="text-align:left;list-style: none;">
    foreach (var processo in Model.Receita.Processos.OrderBy(p => p.Indice))
    {
        <li>
            <ul style="text-align:left;">
                foreach (var tarefa in processo.Tarefas.OrderBy(t => t.Indice))
                {
                    <li>
                        foreach (var texto in tarefa.Texto.OrderBy(t => t.Indice))
                        {
                            if (texto.IngredienteId != null)
                            {
                                <a asp-controller="Ingredientes" asp-action="Detalhes" asp-route-id="texto.IngredienteId">texto.Texto</a>
                            }
                            else if (texto.TecnicaId != null)
                            {
                                <a asp-controller="Tecnicas" asp-action="Detalhes" asp-route-id="texto.TecnicaId">texto.Texto</a>
                            }
                            else if (texto.UtensilioId != null)
                            {
                                <a asp-controller="Utensilios" asp-action="Detalhes" asp-route-id="texto.UtensilioId">texto.Texto</a>
                            }
                            else
                            {
                                <text>texto.Texto</text>
                            }
                        }
                        {
                            var duracaoTemporizador = tarefa.GetDuracaoTemporizador();

                            if (duracaoTemporizador != null)
                            {
                                <text><strong>(eu sou um temporizador de duracaoTemporizador minutos)</strong></text>
                            }
                        }
                    </li>
                }
            </ul>
        </li>
    }
</ul>
    -->
